# My Beer Log API 権限マトリクス

## ユーザータイプ定義

| ユーザータイプ | 説明 | 認証要件 |
|---------------|------|----------|
| **PF管理者** | プラットフォーム管理者 | AWS Cognito認証 + 管理者グループ |
| **醸造所管理者** | 醸造所の管理者 | AWS Cognito認証 + 醸造所管理者グループ |
| **一般ユーザー** | 認証済みの一般ユーザー | AWS Cognito認証 |
| **ゲスト** | 未認証ユーザー | 認証不要 |

## API権限マトリクス

| エンドポイント | メソッド | PF管理者 | 醸造所管理者 | 一般ユーザー | ゲスト | 備考 |
|---------------|----------|:--------:|:----------:|:----------:|:------:|------|
| `/health` | GET | ✅ | ✅ | ✅ | ✅ | 認証不要 |
| `/users/profile` | GET | ✅ | ✅ | ✅ | ❌ | 自分のプロファイルのみ |
| `/users/profile` | POST | ✅ | ✅ | ✅ | ❌ | 初回プロファイル作成 |
| `/users/profile` | PUT | ✅ | ✅ | ✅ | ❌ | 自分のプロファイルのみ |
| `/breweries` | GET | ✅ | ✅ | ✅ | ⚠️ | ゲストは基本情報のみ |
| `/breweries` | POST | ✅ | ❌ | ❌ | ❌ | PF管理者のみ醸造所登録可能 |
| `/breweries/{id}` | GET | ✅ | ✅ | ✅ | ⚠️ | ゲストは基本情報のみ |
| `/checkin` | POST | ✅ | ✅ | ✅ | ❌ | GPS位置情報必須 |
| `/visits` | GET | ✅ | ✅ | ✅ | ❌ | 自分の訪問履歴のみ |
| `/visits/{id}` | GET | ✅ | ✅ | ✅ | ❌ | 自分の訪問履歴のみ |

## 権限記号説明

- ✅ **フルアクセス**: すべての機能を利用可能
- ⚠️ **制限付きアクセス**: 一部機能のみ利用可能
- ❌ **アクセス不可**: 利用不可

## 詳細権限仕様

### ヘルスチェック
- **`GET /health`**
  - 全ユーザー: API稼働状況確認

### ユーザープロファイル管理
- **`GET /users/profile`**
  - 認証済みユーザー: 自分のプロファイル情報取得
- **`POST /users/profile`**
  - 認証済みユーザー: 初回プロファイル作成（1回のみ）
- **`PUT /users/profile`**
  - 認証済みユーザー: 自分のプロファイル更新

### 醸造所情報管理
- **`GET /breweries`**
  - 認証済みユーザー: フル情報（位置情報、詳細情報）
  - ゲスト: 基本情報のみ（名称、住所、説明）
- **`POST /breweries`**
  - PF管理者: 新規醸造所登録
  - その他: 403 Forbidden
- **`GET /breweries/{id}`**
  - 認証済みユーザー: フル情報
  - ゲスト: 基本情報のみ

### 訪問・チェックイン機能
- **`POST /checkin`**
  - 認証済みユーザー: GPS位置情報によるチェックイン
  - 位置情報検証: 醸造所から半径100m以内
- **`GET /visits`**
  - 認証済みユーザー: 自分の訪問履歴のみ
  - 他ユーザーの履歴: 403 Forbidden
- **`GET /visits/{id}`**
  - 認証済みユーザー: 自分の訪問履歴詳細のみ
  - 他ユーザーの履歴: 403 Forbidden

## 認証・認可の実装

### AWS Cognito統合
```
Authorization: Bearer <JWT_TOKEN>
```

### ユーザーグループ管理
- **admin**: PF管理者権限
- **brewery_manager**: 醸造所管理者権限
- **user**: 一般ユーザー権限（デフォルト）

### 権限チェックフロー
1. JWT Token検証
2. ユーザーグループ確認
3. リソースアクセス権限チェック
4. レスポンス情報フィルタリング

## セキュリティ考慮事項

### データアクセス制御
- ユーザーは自分のプロファイル・訪問履歴のみアクセス可能
- 位置情報は認証済みユーザーのみ取得可能
- 醸造所登録はPF管理者のみ実行可能

### レート制限
- チェックイン: 同一醸造所への連続チェックインは1時間に1回まで
- API全般: ユーザーあたり1000リクエスト/時間

### GPS位置情報検証
- チェックイン時に醸造所から半径100m以内であることを検証
- 位置情報の精度が低い場合はエラーを返却